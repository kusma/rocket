language: c

sudo: false

os:
  - linux

before_script:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      brew update &&
      brew install qt5 &&
      brew install sdl &&
      export QT5_PREFIX="`brew --prefix qt5`";
      export QMAKE="$QT5_PREFIX/bin/qmake";
    fi
  - if [ ! -f deps/bass24.zip ]; then
        mkdir -p deps && (
            cd deps &&
            wget http://www.un4seen.com/files/bass24-$TRAVIS_OS_NAME.zip -O bass24.zip
        )
    fi &&
    mkdir examples/include &&
    mkdir examples/lib &&
    unzip -d bass24 deps/bass24.zip &&
    cp bass24/bass.h examples/include/;
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      cp bass24/libbass.dylib examples/lib/;
    fi;
    if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      cp bass24/x64/libbass.so examples/lib/;
    fi
  - if [ -n "$TRAVIS_TAG" ]; then
      export VERSION_TAG=${TRAVIS_TAG:1};
    else
      export VERSION_TAG=$TRAVIS_BRANCH;
    fi

script:
  - make &&
    make examples/example_bass &&
    make examples/example_bass-player

cache:
  directories:
    - deps

env:
  global:
   # COVERITY_SCAN:
   - secure: "dZNAhgt6wfl/JzKI0PwnHjIzhCZsuIcsvzpKIHpM0EHSosaCbhyO0pY3vRJmF08fa01TQ5lHFS5sNNkBPaDxRQvbXEa7jDECR6sq+gm9zpioaAAgKF6ge9Rt/wbZ5I3L4xDHpwLLjGB/uOBorEEp2TxFI2xWVRVrc4Qx74KfSL0oiBprBk5JPblfCiwVI2CtXcKm3kgdSIjcqkrHro+Be052oHuyVniOGClDpVWVFJIX+nlixwoIw7QUjyTjpFlgEe5a13icJf7ms/RibC6ePB698aUhv4+e76vcsvdC0R+0h1vTfb2KtF6XGNXDA76PPE4GHzX6fio1V2ZVexPV/C+IlXkVFgjne7h6FD0yA4AVOH1JsodWfN5Y0USAzQyLW59XvffZZ6gKjf32VfCRRLWlvOW6qwmp3rrLHxcLNm9/BHz+ix3XJ9AeBFDfVxvXmlYdNz/Msz1n+hq6xdjKu7ORmmo0utAIwjRtRAZW9kDLYdMOFbkCULcbJC4r4Ka4SL6w6X5RIcJWjWfNuMY/IAIGOBx451/P5vr5rO95Cx20zKd0mgOiZgusjnoI4wwODHaboIKkJVeZnCioKYBtxCHnlAR83AYhe3uk/6yTr3HVI70H1AIMccBKqWuhgTZFMWmSqR2GsrBz+m6R/OdNv9pCfYr+ZJ9kNkHzeq8R8XQ="

addons:
  apt:
    packages:
      - libsdl1.2-dev
  coverity_scan:
    project:
      name: "kusma/rocket"
      description: "GNU Rocket"
    notification_email: kusmabite@gmail.com
    build_command_prepend: ""
    build_command: "make all examples/example_bass examples/example_bass-player"
    branch_pattern: coverity_scan

before_deploy:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      (cd editor &&
      "$QT5_PREFIX/bin/macdeployqt" editor.app &&
      prefix="`grealpath $QT5_PREFIX`";
      frameworks=(editor.app/Contents/Frameworks/Qt*.framework) &&
      frameworks=("${frameworks[@]#editor.app/Contents/Frameworks/}") &&
      frameworks=("${frameworks[@]%.framework}") &&
      for framework in "${frameworks[@]}"; do
        for target in "${frameworks[@]}"; do
          install_name_tool -change $prefix/lib/$target.framework/Versions/5/$target @executable_path/../Frameworks/$target.framework/Versions/5/$target editor.app/Contents/Frameworks/$framework.framework/$framework;
        done;
      done;
      for plugin in editor.app/Contents/PlugIns/*/*.dylib; do
        for target in "${frameworks[@]}"; do
          install_name_tool -change $prefix/lib/$target.framework/Versions/5/$target @executable_path/../Frameworks/$target.framework/Versions/5/$target $plugin;
        done;
      done;
      zip -r rocket-editor-$VERSION_TAG-$TRAVIS_OS_NAME.zip editor.app)
    fi

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: aCUNNh7Gevkxjjw6RE6xf1JpWPIHFrmmTGBsOgJ9J0hLDanxZRVZM0f4xgK3PArIFjL/9l3ollGlTjZuvkpiU7SieIpfbA5XJHwl/P1Kyw7lTu81e+CWttVDfL9r/x3JTT42lSM6ICLOJLuvZryrnNxRGTcntxebm7+g2vmh8nQ=
  file: editor/rocket-editor-$VERSION_TAG-$TRAVIS_OS_NAME.zip
  on:
    tags: true
    condition: $TRAVIS_OS_NAME = osx
